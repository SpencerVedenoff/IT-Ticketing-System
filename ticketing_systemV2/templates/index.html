<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IT Support Ticketing System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

<!-- Header Section with Logo -->
<div style="display: flex; align-items: center; gap: 15px;">
    <img src="{{ url_for('static', filename='Logo.jpg') }}" alt="Company Logo" style="width: 80px; height: 80px; border-radius: 10px;">
    <h1>IT Support Ticketing System</h1>
</div>

<!-- Create Ticket Button -->
<a href="/new_ticket" class="button">Create New Ticket</a>

<!-- Filter by Status -->
<form method="GET" action="/">
    <label for="status-filter">Filter by Status:</label>
    <select id="status-filter" name="status" onchange="this.form.submit()">
        <option value="All" {% if current_filter == 'All' or current_filter is none %}selected{% endif %}>All</option>
        <option value="Open" {% if current_filter == 'Open' %}selected{% endif %}>Open</option>
        <option value="In Progress" {% if current_filter == 'In Progress' %}selected{% endif %}>In Progress</option>
        <option value="Closed" {% if current_filter == 'Closed' %}selected{% endif %}>Closed</option>
    </select>
</form>

<h2>All Tickets</h2>

<table>
    <tr>
        <th>Title</th>
        <th>Description</th>
        <th>Status</th>
        <th>Created At</th>
        <th>Sender Info</th>
        <th>Actions</th>
    </tr>

    {% for ticket in tickets %}
    <tr>
        <td>{{ ticket.title }}</td>
        <td>{{ ticket.description }}</td>
        <td>{{ ticket.status }}</td>
        <td>{{ ticket.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td>{{ ticket.sender_name }} ({{ ticket.sender_email }})</td> <!-- New Column -->
        <td><a href="/view_ticket/{{ ticket.id }}">View</a></td>
    </tr>
    {% endfor %}
</table>

<!-- Show More Button -->
<div id="show-more-container">
    {% if tickets|length == limit %}
        <button id="show-more" data-limit="{{ limit }}" class="btn btn-primary">
            Show More
        </button>
    {% endif %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const showMoreButton = document.getElementById("show-more");
        if (showMoreButton) {
            showMoreButton.addEventListener("click", function () {
                const limit = parseInt(this.getAttribute("data-limit"), 10);
                const newLimit = limit + 20; // Increment the limit by 20
                const url = `/?limit=${newLimit}&status={{ current_filter|default('All') }}`;
                
                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, "text/html");
                        const newRows = doc.querySelector("table tbody").innerHTML;
                        document.querySelector("table tbody").innerHTML = newRows;
                        
                        const container = doc.querySelector("#show-more-container").innerHTML;
                        document.querySelector("#show-more-container").innerHTML = container;
                    })
                    .catch(err => console.error("Error loading more tickets:", err));
            });
        }
    });
</script>

{% if not tickets %}
    <p>No tickets available.</p>
{% endif %}

</body>
</html>
